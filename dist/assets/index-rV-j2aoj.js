import{j as e,L as R,S as xe,R as I,C as w,w as D}from"./semi-ui-OxdfDuUU.js";import{a as i}from"./react-core-CuH21x-Y.js";import{U as pe,n as je,t as b,o as ve,r as k,p as A,q as m,v as fe,w as ge,I as N,A as P,l as U,x as ye,y as L,z as _e}from"./index-DxyIvJve.js";import{u as Te}from"./i18n-QhEt9g7K.js";import{a as Se}from"./visactor-B2DdUf6u.js";import"./tools-Bq27s6dB.js";import"./react-components-mc6CzEtb.js";import"./semantic-CG_yn6tB.js";const Pe=we=>{var F,E,Q;const{t:h}=Te();i.useRef();let g=new Date;const[x,W]=i.useContext(pe),[y,De]=i.useContext(je),[z,be]=i.useState({username:"",token_name:"",model_name:"",start_timestamp:localStorage.getItem("data_export_default_time")==="hour"?b(g.getTime()/1e3-86400):localStorage.getItem("data_export_default_time")==="week"?b(g.getTime()/1e3-86400*30):b(g.getTime()/1e3-86400*7),end_timestamp:b(g.getTime()/1e3+3600),channel:"",data_export_default_time:""}),{username:K,model_name:Ce,start_timestamp:V,end_timestamp:Y,channel:ke}=z,G=ve(),M=i.useRef(!1),[H,$]=i.useState(!1),[Ae,J]=i.useState([]),[q,O]=i.useState(0),[X,Z]=i.useState(0),[B,ee]=i.useState(0),[v,Ne]=i.useState(localStorage.getItem("data_export_default_time")||"hour"),[se,te]=i.useState([{type:"null",value:"0"}]),[ae,le]=i.useState([]),[Me,ie]=i.useState({type:"pie",data:[{id:"id0",values:se}],outerRadius:.8,innerRadius:.5,padAngle:.6,valueField:"value",categoryField:"type",pie:{style:{cornerRadius:10},state:{hover:{outerRadius:.85,stroke:"#000",lineWidth:1},selected:{outerRadius:.85,stroke:"#000",lineWidth:1}}},title:{visible:!0,text:h("模型调用次数占比"),subtext:`${h("总计")}：${k(B)}`},legends:{visible:!0,orient:"left"},label:{visible:!0},tooltip:{mark:{content:[{key:t=>t.type,value:t=>k(t.value)}]}},color:{specified:A}}),[ne,oe]=i.useState({type:"bar",data:[{id:"barData",values:ae}],xField:"Time",yField:"Usage",seriesField:"Model",stack:!0,legends:{visible:!0,selectMode:"single"},title:{visible:!0,text:h("模型消耗分布"),subtext:`${h("总计")}：${m(q,2)}`},bar:{state:{hover:{stroke:"#000",lineWidth:1}}},tooltip:{mark:{content:[{key:t=>t.Model,value:t=>m(t.rawQuota||0,4)}]},dimension:{content:[{key:t=>t.Model,value:t=>t.rawQuota||0}],updateContent:t=>{t.sort((l,o)=>o.value-l.value);let r=0;for(let l=0;l<t.length;l++){if(t[l].key=="其他")continue;let o=parseFloat(t[l].value);isNaN(o)&&(o=0),t[l].datum&&t[l].datum.TimeSum&&(r=t[l].datum.TimeSum),t[l].value=m(o,4)}return t.unshift({key:h("总计"),value:m(r,4)}),t}}},color:{specified:A}}),[re,ce]=i.useState({}),de=async()=>{$(!0);try{let t="",r=Date.parse(V)/1e3,l=Date.parse(Y)/1e3;G?t=`/api/data/?username=${K}&start_timestamp=${r}&end_timestamp=${l}&default_time=${v}`:t=`/api/data/self/?start_timestamp=${r}&end_timestamp=${l}&default_time=${v}`;const o=await P.get(t),{success:_,message:T,data:c}=o.data;_?(J(c),c.length===0&&c.push({count:0,model_name:"无数据",quota:0,created_at:g.getTime()/1e3}),c.sort((f,d)=>f.created_at-d.created_at),me(c)):U(T)}finally{$(!1)}},ue=async()=>{await de()},me=t=>{let r=[],l=[],o=0,_=0,T=new Set,c=0;t.forEach(s=>{T.add(s.model_name),c+=s.token_used,o+=s.quota,_+=s.count});const f={};Array.from(T).forEach(s=>{f[s]=A[s]||re[s]||ye(s)}),ce(f);let d=new Map;t.forEach(s=>{const a=L(s.created_at,v),p=s.model_name,n=`${a}-${p}`;d.has(n)||d.set(n,{time:a,model:p,quota:0,count:0});const u=d.get(n);u.quota+=s.quota,u.count+=s.count});let S=new Map;for(let[s,a]of d)S.has(a.model)||S.set(a.model,0),S.set(a.model,S.get(a.model)+a.count);r=Array.from(S).map(([s,a])=>({type:s,value:a}));let C=Array.from(new Set([...d.values()].map(s=>s.time)));if(C.length<7){const s=Math.max(...t.map(p=>p.created_at)),a=v==="hour"?3600:v==="day"?86400:604800;C=Array.from({length:7},(p,n)=>L(s-(6-n)*a,v))}C.forEach(s=>{let a=Array.from(T).map(n=>{const u=`${s}-${n}`,j=d.get(u);return{Time:s,Model:n,rawQuota:(j==null?void 0:j.quota)||0,Usage:j!=null&&j.quota?_e(j.quota,4):0}});const p=a.reduce((n,u)=>n+u.rawQuota,0);a.sort((n,u)=>u.rawQuota-n.rawQuota),a=a.map(n=>({...n,TimeSum:p})),l.push(...a)}),r.sort((s,a)=>a.value-s.value),l.sort((s,a)=>s.Time.localeCompare(a.Time)),ie(s=>({...s,data:[{id:"id0",values:r}],title:{...s.title,subtext:`${h("总计")}：${k(_)}`},color:{specified:f}})),oe(s=>({...s,data:[{id:"barData",values:l}],title:{...s.title,subtext:`${h("总计")}：${m(o,2)}`},color:{specified:f}})),te(r),le(l),O(o),ee(_),Z(c)},he=async()=>{let t=await P.get("/api/user/self");const{success:r,message:l,data:o}=t.data;r?W({type:"login",payload:o}):U(l)};return i.useEffect(()=>{he(),M.current||(fe({isWatchingThemeSwitch:!0}),M.current=!0,ue())},[]),e.jsx(e.Fragment,{children:e.jsx(R,{children:e.jsx(R.Content,{children:e.jsxs(xe,{spinning:H,children:[e.jsxs(I,{gutter:{xs:16,sm:16,md:16,lg:24,xl:24,xxl:24},style:{marginTop:20},type:"flex",children:[e.jsx(w,{span:y.isMobile?24:9,children:e.jsxs(D,{className:"panel-desc-card balance",children:[e.jsx("div",{className:"title",children:e.jsx("h3",{children:"Balance Summary"})}),e.jsxs("div",{className:"stats",children:[e.jsxs("div",{className:"stat",children:[e.jsx("h4",{children:"Current Bal"}),e.jsxs("p",{children:[" ",m((F=x==null?void 0:x.user)==null?void 0:F.quota)]})]}),e.jsxs("div",{className:"stat",children:[e.jsx("h4",{children:"Spent"}),e.jsxs("p",{children:[" ",m((E=x==null?void 0:x.user)==null?void 0:E.used_quota)]})]}),e.jsxs("div",{className:"stat",children:[e.jsx("h4",{children:"Requests"}),e.jsxs("p",{children:[" ",(Q=x.user)==null?void 0:Q.request_count]})]})]}),e.jsx("div",{className:"line",children:e.jsx("img",{src:ge,alt:""})})]})}),e.jsx(w,{span:y.isMobile?24:8,children:e.jsxs(D,{className:"panel-desc-card ",children:[e.jsx("div",{className:"title",children:e.jsx("h3",{children:"Statistical Summary"})}),e.jsxs("div",{className:"stats",children:[e.jsxs("div",{className:"stat",children:[e.jsx("h4",{children:"Qouta"}),e.jsxs("p",{children:[" ",m(q)]})]}),e.jsxs("div",{className:"stat",children:[e.jsx("h4",{children:"Tokens"}),e.jsxs("p",{children:[" ",X]})]}),e.jsxs("div",{className:"stat",children:[e.jsx("h4",{children:"Count"}),e.jsxs("p",{children:[" ",B]})]})]})]})}),e.jsx(w,{span:y.isMobile?24:6,style:{width:"29%"},children:e.jsxs(D,{className:"panel-desc-card rpm",children:[e.jsxs("div",{className:"title",children:[e.jsxs("div",{className:"heading",children:[e.jsx("h3",{children:"Average RPM"}),e.jsx("span",{children:"0"})]}),e.jsxs("div",{className:"arrow",children:[e.jsx("p",{children:"This Week "}),e.jsx(N,{className:"ml-2"})]})]}),e.jsx("div",{className:"title",children:e.jsxs("div",{className:"heading",children:[e.jsx("h3",{children:"Average RPM"}),e.jsx("span",{children:"0"})]})})]})})]}),e.jsxs(D,{style:{marginTop:20},children:[e.jsxs("div",{className:"chart-head",children:[e.jsx("h3",{children:"Model Consumption distribution"}),e.jsxs("ul",{children:[e.jsxs("li",{children:["All Tokens ",e.jsx(N,{})," "]}),e.jsxs("li",{children:["10 Nov 2024 - 16 Dec 2024 ",e.jsx(N,{})," "]})]})]}),e.jsx(Se,{spec:ne,option:{mode:"desktop-browser"}})]}),e.jsxs(I,{gutter:{xs:16,sm:16,md:16,lg:24,xl:24,xxl:24},style:{marginTop:20},type:"flex",children:[e.jsx(w,{span:y.isMobile?24:16,children:e.jsxs(D,{children:[e.jsx("h4",{children:"Model Calls Distribution"}),e.jsxs("div",{class:"main-card",children:[e.jsx("img",{src:"https://img.icons8.com/ios-filled/50/000000/pie-chart.png",alt:"Chart Icon"}),e.jsx("h2",{children:"No Data Yet?"}),e.jsx("p",{children:"Add Tokens to start tracking Calls Distribution Metrics."}),e.jsxs("button",{children:[e.jsx("img",{src:"https://img.icons8.com/ios-filled/50/ffffff/plus.png",alt:"Plus Icon"}),"New Token"]})]})]})}),e.jsx(w,{span:y.isMobile?24:8,children:e.jsxs("div",{class:"summary-cards",children:[e.jsxs("div",{class:"summary-card shadow",children:[e.jsx("h4",{children:"Tokens Summary"}),e.jsx("div",{class:"value",children:"0"}),e.jsx("div",{class:"sub-value",children:"Tokens"}),e.jsx("div",{class:"sub-value",children:"Requests"})]}),e.jsxs("div",{class:"summary-card shadow",children:[e.jsx("h4",{children:"Calls Summary"}),e.jsx("div",{class:"value",children:"0"}),e.jsx("div",{class:"sub-value",children:"No. of Calls"}),e.jsx("div",{class:"sub-value",children:"Success"}),e.jsx("div",{class:"sub-value",children:"Failed"})]})]})})]})]})})})})};export{Pe as default};
